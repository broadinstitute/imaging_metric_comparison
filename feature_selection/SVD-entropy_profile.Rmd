---
title: "SVD-entropy feature selection on profile"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(dplyr)
library(tidyverse)
library(stringr)
```

## import the data

```{r import data, message=FALSE}

# name of the profile data (in order to remove not meaningfull data)
data.filename <- "Pf_Gustafsdottir.rds"

# import data
pf <- readRDS(file.path("..", "..", "input", "BBBC022_2013", "old", data.filename))

profiles <- pf$data[,pf$feat_cols]

dim(profiles)

start.time <- Sys.time()

# transpose the dataset to have featxobs (mxn)
X <- profiles %>% as.matrix() %>% t(.)
A <- tcrossprod(X, X) 

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken 
```

```{r feature selection with FS2 new}
start.time <- Sys.time()

# load the c++ function
Rcpp::sourceCpp('ranking_SVD_entropy.cpp')

n.feat <- length(pf$feat_cols)

feat.idx <- CE_entropy_FS2_new(A, n.feat)

# names of the features to keep
names.CEi <- rownames(X)[feat.idx[1:n.feat]]

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken # 
```

feat.idx <- c(56, 1, 267, 185,  33, 307, 278, 45, 281, 46, 121, 282, 283, 273, 287, 114, 47, 277, 270, 262, 288, 120, 170, 171, 261, 552, 292, 591, 291, 115, 276, 418, 417, 23, 34, 286, 416, 6, 590, 349, 271, 285, 584, 259, 558, 575, 279,  26, 275, 280, 579, 284, 583, 389, 274, 290, 589, 272, 571, 265, 58, 253, 517, 518, 767, 766, 175, 5, 35, 574, 211, 179, 468, 415, 164, 557, 258, 7, 36, 215, 214, 153, 527, 547, 548, 537, 538, 467, 528, 566, 195, 578, 289, 588, 117, 116, 231, 210, 230, 22, 393, 266, 269, 24, 16, 165, 204, 145, 118, 119, 59, 189, 191, 737, 48, 218, 219, 150, 398, 570, 144,  41, 586, 577, 587, 608, 40, 653, 354, 648, 98, 406, 361, 362, 565, 263, 254, 582, 57, 205, 151, 181, 410, 573, 385, 607, 337, 636, 342, 641, 601, 302, 130, 131,  85, 90, 293,  42, 184,  37, 733, 569, 309, 747, 294, 568, 183, 235, 139, 135, 402, 239, 103, 249, 159, 141, 221, 220, 592,  14, 264,  25, 248, 238, 233, 188, 229, 228, 199, 241, 251, 250, 240, 736, 609, 234, 244, 245, 161, 160, 173, 152, 182, 667, 232, 133, 201, 169, 208, 168, 209, 225, 224, 683, 125, 155, 154, 124, 149, 129, 148, 158, 403, 198, 138, 532, 82, 526, 217, 216, 525, 466, 308, 51, 76, 81, 106, 86, 91, 71, 646, 96, 631, 549, 550, 539, 55, 66, 317, 101, 616, 61, 611, 352, 107, 77, 52, 617, 318, 353, 102, 652, 647, 97,  62, 67, 612, 72, 243, 242, 405, 358, 531, 650, 654, 356, 100, 99, 105, 645,  80, 351,  75,  50, 326,  70,  95, 346, 610, 381, 655, 123, 404, 319, 618,  68,  63, 649, 613, 625, 331, 620,  60,  65, 108, 157, 127, 390, 316, 615,  83, 350,  78, 311, 666, 542, 541, 193, 43, 399, 401, 630, 619, 143, 540, 564, 53, 359, 73, 658, 348, 593, 400, 49, 465, 388, 128, 777, 776, 92, 87, 328, 373, 746, 190, 192, 313, 147, 247, 614,  64, 355, 178, 27, 17, 104, 295, 246, 665, 621, 488, 657, 2, 236, 237, 332, 729, 142, 255)
[370]  30 787 664 745 227 226 166 167 146 207 194 132  10 177 206 546 545 187 735 367 594 786 749 268  32 298 314 197 585 741 213 212 387 744  31  44 535 536 137 310 600
[411] 301 333 627 296 297 329 651 196 186 140 200 386 374 371 372 368 260 377 370 383 384 369 498 487 687 134 299 725 727 721 731 122 136 775 516 515 717 109 176  11  39
[452]  38  19  29 628 334  88  93 633  74  84 320 360  54  79  69 623 659 774 327 300  21 606 656  15  20  28 315  18  13  12  94  89 330 789 788 597 716 530 740 438 497
[493] 304 622 561 203 223 222 156 126 494 446 715 324 595 437 686 603 378 365 336 635 640 341 321 493 534 202 163 162 799 629 624 563 626 322 605 598 394 739 599 714 785
[534] 632 798 376 529 784 335 634 366 554 375 567 581 723 544 533 543 795 496 495 794 797 796 452 572 306 112 113 395 748 407 392 456 560 364 363 506 639 340 638 339 345
[575] 644 344 643 325 604 305 180 685 734 111 382 508 252 555 596 722 256 551 379 448 507 757 458 391 709 701 460 779 110 764 765 396 728 303 174 682 732 580 726 428 637
[616] 338 602 343 642 323 724 347 312 357 695 445 556 409 408 380 420 426 422 679 505 720 671 705 447 697 756 257 778 684 419 696 522 397 436 435 486 485 755 780 781 791
[657] 790 681 708 430 470 694 476 521 669 707 738 743 677 454 719 668 512 462 511 451 457 689 675 678 700 699 706 427 676 450 442 670 730 754 472 421 768 769 461 492 459
[698] 455 576 172 718 520 519 469 553 559 703 524 474 759 480 704 523 444 478 414 673 510 562 464 413 702 424 463 672 792 514 513 443 783 793 782 698 688 449 425 680 491
[739] 432 674 429 758 453 504 482 441 691 502 484 490 509 503 477 692 693 752 423 753 690 763 762 773 772 712 713 662 663   8 742   3   4 489 481 412 483 411 751 501 761
[780] 760 750 771   9 770 711 661 660 710 431 500 434 440 499 433 439 479 475 471 473



```{r save}
# select the features
pf_sel <- pf
pf_sel$data %<>% select(one_of(names.CEi, pf_sel$factor_cols))

pf_sel$feat_cols <- names.CEi

# save dataset
filename <- paste("../../../input/BBBC022_2013/Profile/feat_selected/BBBC022_fs_SVD_", 
                        as.character(n.feat),
                        ".rds",
                        sep = "")
pf_sel %>%
  saveRDS(filename)

```


