---
title: "Feature Selection"
output:
  html_document: default
  html_notebook: default
---

This Markdown aims at doing feature selection. In this version, we use findCorrelation to remove the features that are too correlated.

```{r libraries, include=FALSE, message=FALSE}
library(ggplot2)
library(caret)
library(magrittr)
library(dplyr)
library(tidyverse)
library(stringr)
```

## Data

The input contains only the high median correlation compounds.
The input data is a 3752 by 803 matrix.
There are 3752 different observations and 799 features (extracted with CellProfiler).
Each compound (938 different) has 4 replicates.

```{r import data, message=FALSE}
set.seed(42)

profiles <- 
  list.files("../../backend/BBBC022_2013/", 
          pattern = "*_normalized.csv",
          recursive = T,
          full.names = T) %>%
  map_df(read_csv)

dim(profiles)

variables <-
  names(profiles) %>% str_subset("^Cells_|^Cytoplasm_|^Nuclei_")

metadata <-
  names(profiles) %>% str_subset("^Metadata_")
  
```

## Feature Selection

```{r correlation}
# remove zero variance data
profiles %<>%
  cytominer::select(
    sample = 
      profiles %>% 
      filter(Metadata_pert_type == "control"),
    variables = variables,
    operation = "variance_threshold"
  )

variables <-
  names(profiles) %>% str_subset("^Cells_|^Cytoplasm_|^Nuclei_")

# correlation between features
correlation <- 
  profiles %>%
  select(one_of(variables)) %>%
  cor()

corrplot::corrplot(correlation, tl.cex = 0.5, method = "color",  tl.pos="n", order = "hclust")
```


```{r find correlation}
# remove features that are too correlated (threshold of .9)
profiles %<>%
  cytominer::select(
    sample = profiles,
    variables = variables,
    operation = "correlation_threshold"
  )

#%>%filter(Metadata_pert_type == "control"),

variables <-
  names(profiles) %>% str_subset("^Cells_|^Cytoplasm_|^Nuclei_")

# plot of the correlation after features selection
correlation <- 
  profiles %>%
  select(one_of(variables)) %>%
  cor()

corrplot::corrplot(correlation, tl.cex = 0.5, method = "color",  tl.pos="n", order = "hclust")

dim(profiles)

# saving the new dataset
profiles %>%
  write_csv("../../input/BBBC022_2013_sel_feat.csv")
```

