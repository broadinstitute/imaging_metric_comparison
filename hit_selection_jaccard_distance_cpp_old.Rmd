---
title: "Hit Selection Jaccard distance cpp old"
output: html_document
---

## Data

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
# all usefull libraries
library(magrittr)
library(dplyr)
library(ggplot2)
library(foreach)
library(doMC)
library(stringr)
library(tidyverse)
```

## Parameter
```{r parameter}
# name of the data file
filename <- "Pf_Gustafsdottir_fs.rds" 
#filename <- "Pf_Gustafsdottir.rds"

# number of data to make the non replicate correlation
N <- 5000

# seed for the reproducibility
set.seed(42)

# number of CPU cores for parallelization
registerDoMC(7)

# number of features to take
n.feat <- 30
```


## Import data
```{r import data}
# import data
pf <- readRDS(file.path("..", "..", "input", "BBBC022_2013", "old", filename)) # 7680x803

# Remove the negative control from the data
pf$data <- filter(pf$data, !Image_Metadata_BROAD_ID %in% "") # 6400x803

```

## Separation of data

```{r separation of data}
# find the different compounds
IDs <- distinct(pf$data, Image_Metadata_BROAD_ID)
dim(IDs)
```

## Distance of the data

```{r distance in parallel}
start.time <- Sys.time()

# load the c++ function
Rcpp::sourceCpp('jaccard_distance_function.cpp')


# loop over all IDs and save the median of the distance
comp.dist.median <- foreach(i = 1:length(IDs$Image_Metadata_BROAD_ID), .combine=cbind) %dopar% {

  #filtering to choose only for one compound
  comp <-
    filter(pf$data, Image_Metadata_BROAD_ID %in% IDs$Image_Metadata_BROAD_ID[i])
  comp <-
    comp[, pf$feat_cols] %>%
    as.matrix()

  # distance of the features
  comp.dist <- vecJaccardDistance(comp, n.feat)
  
  # save median of the distance
  comp.dist.median <- 
    median(comp.dist, na.rm=TRUE)

}

hist(comp.dist.median,
     main="Histogram for Median Replicate Distance",
     xlab="Median Replicate Distance", 
     xlim = range(0, 1))

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken # 10 secs 
```


## Thresholding of poor replicate distance

H0: median non replicate distance

The Null distribution is estimated by finding the median distance of non replicates. 
Select randomly 4 replicates each coming from a different compound and calculate the median distance. 
Repeat this N times to get a distribution.
Finally estimate a threshold (5th percentile) to filter out compounds with poor replicate distance.

```{r non replicate distance parallel}
start.time <- Sys.time()

# set seed for reproducibility
set.seed(42)

# random sequence for reproducibility
a <- sample(1:10000, N, replace=F)

# loop over N times to get a distribution
random.replicate.dist.median <- foreach(i = 1:N, .combine=cbind) %dopar% {
  # set seed according to random sequence
  set.seed(a[i])
  
  # group by IDs
  # sample fixed number per group -> choose 4 replicates randomly from different group
  random.replicate <- 
    pf$data %>% 
    group_by(Image_Metadata_BROAD_ID) %>% 
    sample_n(1, replace = FALSE) %>% 
    ungroup(random.replicate)
  random.replicate <- sample_n(random.replicate, 4, replace = FALSE)
  
  
  comp <- random.replicate[,pf$feat_cols] %>% 
    as.matrix()
  
  # distance of the features
  comp.dist <- vecJaccardDistance(comp, n.feat)
  
  # median of the non replicate distance
  random.replicate.dist.median <- median(comp.dist,na.rm=TRUE)
  
}

# histogram plot
hist(random.replicate.dist.median,
     main="Histogram for Non Replicate Median Distance",
     xlab="Non Replicate Median Distance", 
     xlim = range(0, 1))

# threshold to determine if can reject H0
thres <- quantile(random.replicate.dist.median, .05)
print(thres)

end.time <- Sys.time() # 45 sec (without feature selection)
time.taken <- end.time - start.time
time.taken
```

## Hit Selection

Select strong replicate.

```{r Hit Selection}
# find indices of replicate median distance < threshold
inds <- which(comp.dist.median < thres)

# find values of the median that are hit selected
hit.select <- comp.dist.median[inds]

# find component that are hit selected
hit.select.IDs <- IDs$Image_Metadata_BROAD_ID[inds]

# ratio of strong median replicate correlation
high.median.dist <- length(hit.select)/length(comp.dist.median)
print(high.median.dist)

```


## Saving data

```{r output data}
# select high median correlation replicate 
pf$data %<>% 
  filter(Image_Metadata_BROAD_ID %in% hit.select.IDs)

# save new dataset
pf %>%
  saveRDS("../../input/BBBC022_2013/old/Hit_jaccard_30n_fs_6206.rds")


```