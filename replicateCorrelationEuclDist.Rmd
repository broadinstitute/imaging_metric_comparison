---
title: "Replicate Distance"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
The goal is to do some Hit Selection. Selecting the compound that have effects, that are showing a phenotype.
Find the median replicate distance. The smaller the distance, the more correlated the replicates are.

Use different type of distance metric:

- Euclidean distance: usual distance between two vectors (L2 norm)
- Maximum distance: maximum distance between two components
- Manhattan distance: absolute distance between two vector (L1 norm)


## Data

The input data is a 7680 by 803 matrix.
There are 7680 different observations and 799 features (extracted with CellProfiler).
Each compound (1600 different) has 4 replicates. The negative control has 1280 replicates.
20 plates with 384 wells in each plate.

```{r setup, include=FALSE}
# all usefull libraries
library(dplyr)
library(ggplot2)
```

```{r import data}
# import data
pf <- readRDS("../input/Pf_Gustafsdottir.rds")

# Remove the negative control from the data
pf$data <- filter(pf$data, !Image_Metadata_BROAD_ID %in% "")
```

## Parameter
```{r parameter}
# method of distance matrix computation: "euclidean" (default), "maximum", "manhattan"
dist.method <- "euclidean"
# number of data to make the non replicate correlation
N <- 5000
```

## Separation of data

Separation is made according to the compound that was added.
Image_Metadata_BROAD_ID = gives the ID of the compound that was added.

```{r separation of data}
# find the different compounds
IDs <- distinct(pf$data, Image_Metadata_BROAD_ID) # 1600
dim(IDs)

```

## Distance of the data

Calculate the distance of the replicate for each compound.

```{r correlation}
comp.dist.median <- c()
# loop over all IDs
for (variable in IDs$Image_Metadata_BROAD_ID){
  #filtering to choose only for one compound
  comp <- filter(pf$data, Image_Metadata_BROAD_ID %in% variable)

  # distance of the features
  comp.dist <- dist(comp[,pf$feat_cols], method = dist.method)
  comp.dist <- as.matrix(comp.dist)
  
  # median of the distances
  comp.dist.median <- c(comp.dist.median, median(comp.dist[lower.tri(comp.dist)],na.rm=TRUE))
}

hist(comp.dist.median,
     main="Histogram for Median Replicate Distance",
     xlab="Median Replicate Distance")
```


## Thresholding of poor replicate correlation

H0: median non replicate correlation.

The Null distribution is estimated by finding the median correlation of non replicates. 
Select randomly 4 replicates each coming for a different compound and calculate the median correlation. 
Repeat this N times to get a distribution.
Finally estimate a threshold (5th percentile) to filter out compounds with poor replicate correlation.

```{r replicate correlation}

# vector of the median of non replicate correlation
random.replicate.dist.median <- c()

# loop over N times to get a distribution
for (i in 1:N){
  # group by IDs
  # sample fixed number per group -> choose 4 replicates randomly from different group
  random.replicate <- pf$data %>% group_by(Image_Metadata_BROAD_ID) %>% sample_n(1, replace = FALSE) %>% ungroup(random.replicate)
  random.replicate <- sample_n(random.replicate, 4, replace = FALSE)
  
  # distance of the features
  random.replicate.dist <- dist(random.replicate[,pf$feat_cols], method = dist.method)
  random.replicate.dist <- as.matrix(random.replicate.dist)
  
  # median of the non replicate distance
  random.replicate.dist.median <- c(random.replicate.dist.median, median(random.replicate.dist[lower.tri(random.replicate.dist)],na.rm=TRUE))
  
}

# histogram plot
hist(random.replicate.dist.median,
     main="Histogram for Non Replicate Median Correlation",
     xlab="Non Replicate Median Correlation")

# threshold to determine if can reject H0
thres <- quantile(random.replicate.dist.median, .05)
print(thres)
```

## Hit Selection

Select strong replicate correlation comparing with the 95th percentile of the Null Distribution.

```{r Hit Selection}
# find indices of replicate median correlation > threshold
inds <- which(comp.dist.median < thres)

# find values of the median that are hit selected
hit.select <- comp.dist.median[inds]

# find component that are hit selected
hit.select.IDs <- IDs$Image_Metadata_BROAD_ID[inds]

# ratio of strong median replicate correlation
high.median.dist <- length(hit.select)/length(comp.dist.median)
print(high.median.dist)

```


## Results

|  Method   | Pearson | Spearman | Kendall | Euclidean | Maximum | Manhattan |
| --------- | ------- | -------- | ------- | --------- | ------- | --------- |
| N = 1000  | 0.5819  | -------- | ------- | --------- | ------- | --------- |
| N = 5000  | 0.5806  | 0.5519   | 0.5419  | 0.4606    | 0.3612  | 0.4875    |
| N = 10000 | 0.5850  | -------- | ------- | --------- | ------- | --------- |


- Difference between Pearson and Spearman correlation seem not to be very significant (no statistical test was performed).
- Distance method compared to correlation metric gives a lower ratio of hit selection (more or less 10% lower).