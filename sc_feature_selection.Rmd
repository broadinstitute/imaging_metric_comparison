---
title: "Single cell feature selection"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(dplyr)
library(tidyverse)
library(stringr)
```

## import the data

```{r import data, message=FALSE}
# name of the single cell data file
filename.sc <- "BBBC022_sampled_10000.rds"

# name of the profile data (in order to remove not meaningfull data)
data.filename <- "Pf_Gustafsdottir.rds"

# import data
pf.sc <- readRDS(file.path("..", "..", "input", "BBBC022_2013", "single_cells", filename.sc)) %>% scale() %>% as.data.frame()
pf <- readRDS(file.path("..", "..", "input", "BBBC022_2013", "old", data.filename))

# difference of features name between old and new version:
# Hoechst -> DNA, Ph_golgi -> AGP, Syto -> RNA
pf$feat_cols <- str_replace(pf$feat_cols, "Hoechst", "DNA")
pf$feat_cols <- str_replace(pf$feat_cols, "Ph_golgi", "AGP")
pf$feat_cols <- str_replace(pf$feat_cols, "Syto", "RNA")
cl <- colnames(pf$data)
cl <- str_replace(cl, "Hoechst", "DNA")
cl <- str_replace(cl, "Ph_golgi", "AGP")
cl <- str_replace(cl, "Syto", "RNA")
colnames(pf$data) <- cl

profiles <- pf.sc[ , colSums(is.na(pf.sc)) == 0] # remove features (columns) where there are NA

feat.delete <- setdiff(colnames(profiles), pf$feat_cols) # features that are in profiles but not in pf

profiles <- profiles[, !names(profiles) %in% feat.delete] # remove features

dim(profiles)

start.time <- Sys.time()

# transpose the dataset to have featxobs (mxn)
X <- profiles %>% as.matrix() %>% t(.)
A <- tcrossprod(X, X) 

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken 
# 0.2144461 seconds for 10193x824
# 6.047441 seconds for 163088x824
# 15.70986 minutes for 1304704x824
```

```{r feature selection with FS2 new}
start.time <- Sys.time()

# load the c++ function
Rcpp::sourceCpp('ranking_SVD_entropy.cpp')

feat.idx <- CE_entropy_FS2_new(A, 700)

# names of the features to keep
names.CEi <- rownames(X)[feat.idx[1:700]]

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken # 2.577435 mins for 1 feature (5.57 hours for 250 features) (6.41 hours for 700 features)
```
Best features: 555, 30, 35, 334, 31, 36, 335, 329, 27, 326, 23, 330, 26, 19, 22, 322, 585, 584, 583, 16, 325, 32, 331, 581, 572, 586, 574, 578, 579, 575, 576, 570, 37, 336, 580, 587, 577, 568, 569, 567, 319, 20, 571, 559, 562, 306, 7, 563, 313, 316, 318, 321, 564, 323, 24, 310, 11, 14, 327, 28, 582, 723, 110, 332, 33, 722, 337, 38, 573, 560, 566, 561, 565, 18, 317, 551, 727, 25, 324, 34, 333, 185, 21, 320 15 314 29 328 39 338 17 729 726 156 152 725 12 550 639 634 144 148 728 13 312 225 471 472 721 619 223 558 56 355 227 720 476 475 658 659 222 477 478 474 473 469 470 221 220 226 315 301 2 724 224 311 557 552 60 229 365 228 111 604 145 61 360 400 96 395 147 138 95 609 644 153 149 663 662 599 130 134 3 766 767 354 55 356 57 358 59 146 157 482 432 431 492 481 491 357 58 142 10 768 769 302 309 151 62 763 762 97 713 712 669 668 128 150 136 705 704 554 709 701 633 638 719 718 759 700 753 772 773 760 761 434 708 764 765 791 790 51 733 743 606 154 679 699 758 678 698 799 778 779 798 132 140 112 137 159 158 707 687 797 747 737 686 746 736 787 786 796 777 776 667 666 706 717 716 677 676 697 757 696 756 607 603 605 788 789 783 141 359 671 670 139 129 133 114 71 795 782 742 732 792 793 752 675 674 794 781 780 155  64 661 660  81 691 681 682 683 680 690 771 770 711 710 751 750 741 731 740 730 689 739 749 685 688 748 738 785 784 695 694 755 754 715 714 665 664 775 774 684 735 745 744 734 184 124 116 120 553 113 435 186 187 436 496 486 495 485  63  99 610 615 645 650 361 125 117 121 126 118 131 135 143 115 122 127 119 123 9 303 4 98 385  86  91 390 350 613 608 643 648 702 693 692 703 673 672 243 242 629 308 635 640 637 642 88 387 401 396 247 246 237 394 636 641 548 490 489 366 67 102 236 536 380 399 283 535 538 547 537 498 497 546 545 544 534 488 494 484 433 493 483 533 543 429 430 480 438 437 487 287 286 297 296 532 531 244 245 235 234 240 241 180 181 530 540 529 539 479 364  65 651 646 282 293 292 277 516 515 267 266 276 167 166 100 93 392 526 416 415 525 217 216 616 205 454 204 453 281 280 291 290 285 284 295 294 165 164 275 274 265 264 279 299 298 289 288 278 231 618 624 654 101 647 652 230 649 614 66 611 362  76 106 182 183 466 465 367 68 207 456 248 589 594 556 542 541 215 214 414 413 524 523 514 513 464 463 195 255 254 194 175 174 444 443 504 503 424 423 458 257 197 177 206 256 196 176 455 426 425 446 445 506 505 528 169 168 527 418 417 249 518 517 219 468 268 269 218 467 368  69 617 363 612 402 403 103 397 620 457 209 201 450 428 448 427 447 508 507 188 189 588 590 591 592 549 595 596 597 593 304 5 305 6 203 208 199 179 259 239 198 178 258 238 202 46 398 104 598 653 628 623 655 600 630 625 105 657 602 632 627 622 656 601 631 626 621 107 109 75 404 80 374 369 108 70 77 406 449 200 405 375 376 420 171 233 379 370  82 371 72 79 40 339 349  50 381 408 407 78 83 377 372 73 382 352  53
Time difference of 5.263528 hours

[1] 555  30  35 334  31  36 335 329  27 326  23 330  26  19  22 322 585 584 583  16 325  32 331 581 572 586 574 578 579 575 576 570  37 336 580 587 577 568 569 567 319  20
 [43] 571 559 562 306   7 563 313 316 318 321 564 323  24 310  11  14 327  28 582 723 110 332  33 722 337  38 573 560 566 561 565  18 317 551 727  25 324  34 333 185  21 320
 [85]  15 314  29 328  39 338  17 729 726 156 152 725  12 550 639 634 144 148 728  13 312 225 471 472 721 619 223 558  56 355 227 720 476 475 658 659 222 477 478 474 473 469
[127] 470 221 220 226 315 301   2 724 224 311 557 552  60 229 365 228 111 604 145  61 360 400  96 395 147 138  95 609 644 153 149 663 662 599 130 134   3 766 767 354  55 356
[169]  57 358  59 146 157 482 432 431 492 481 491 357  58 142  10 768 769 302 309 151  62 763 762  97 713 712 669 668 128 150 136 705 704 554 709 701 633 638 719 718 759 700
[211] 753 772 773 760 761 434 708 764 765 791 790  51 733 743 606 154 679 699 758 678 698 799 778 779 798 132 140 112 137 159 158 707 687 797 747 737 686 746 736 787 786 796
[253] 777 776 667 666 706 717 716 677 676 697 757 696 756 607 603 605 788 789 783 141 359 671 670 139 129 133 114  71 795 782 742 732 792 793 752 675 674 794 781 780 155  64
[295] 661 660  81 691 681 682 683 680 690 771 770 711 710 751 750 741 731 740 730 689 739 749 685 688 748 738 785 784 695 694 755 754 715 714 665 664 775 774 684 735 745 744
[337] 734 184 124 116 120 553 113 435 186 187 436 496 486 495 485  63  99 610 615 645 650 361 125 117 121 126 118 131 135 143 115 122 127 119 123   9 303   4  98 385  86  91
[379] 390 350 613 608 643 648 702 693 692 703 673 672 243 242 629 308 635 640 637 642  88 387 401 396 247 246 237 394 636 641 548 490 489 366  67 102 236 536 380 399 283 535
[421] 538 547 537 498 497 546 545 544 534 488 494 484 433 493 483 533 543 429 430 480 438 437 487 287 286 297 296 532 531 244 245 235 234 240 241 180 181 530 540 529 539 479
[463] 364  65 651 646 282 293 292 277 516 515 267 266 276 167 166 100  93 392 526 416 415 525 217 216 616 205 454 204 453 281 280 291 290 285 284 295 294 165 164 275 274 265
[505] 264 279 299 298 289 288 278 231 618 624 654 101 647 652 230 649 614  66 611 362  76 106 182 183 466 465 367  68 207 456 248 589 594 556 542 541 215 214 414 413 524 523
[547] 514 513 464 463 195 255 254 194 175 174 444 443 504 503 424 423 458 257 197 177 206 256 196 176 455 426 425 446 445 506 505 528 169 168 527 418 417 249 518 517 219 468
[589] 268 269 218 467 368  69 617 363 612 402 403 103 397 620 457 209 201 450 428 448 427 447 508 507 188 189 588 590 591 592 549 595 596 597 593 304   5 305   6 203 208 199
[631] 179 259 239 198 178 258 238 202  46 398 104 598 653 628 623 655 600 630 625 105 657 602 632 627 622 656 601 631 626 621 107 109  75 404  80 374 369 108  70  77 406 449
[673] 200 405 375 376 420 171 233 379 370  82 371  72  79  40 339 349  50 381 408 407  78  83 377 372  73 382 352  53

```{r save}

names.CEi %<>% as.data.frame() 
names.CEi <- rename(names.CEi, feat.name = .)

save(names.CEi, file="selected_features_10000cells_700feat.Rda")

```


